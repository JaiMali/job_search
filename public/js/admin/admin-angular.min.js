var appAccelaar = window.appAccelaar = angular.module('appAccelaar',
  ['ngResource','ui.router','ui.bootstrap','ngTagsInput','smart-table']);

appAccelaar.config(['$stateProvider','$urlRouterProvider',function($stateProvider,$urlRouterProvider){
  $urlRouterProvider.otherwise('/home');
  $stateProvider.state('home',{
    url:'/home',
    templateUrl:'/js/admin/templates/home.html',
    controller: 'HomeController'
  })
    .state('internships',{
      url:'/internships',
      templateUrl:'/js/admin/templates/internship.html',
      controller: 'HomeInternshipController'
    })
    .state('internship',{
      url:'/internship/:id',
      templateUrl:'/js/admin/templates/internship/internship.html',
      controller:'InternshipController'
    })
    .state('company_lis',{
      url:'/company_lists',
      templateUrl:'/js/admin/templates/company.html',
      controller:'HomeCompanyController'
    })
    .state('users',{
      url:'/users',
      templateUrl:'/js/admin/templates/users.html',
      controller:'HomeUserController'
    })
    .state('settings',{
      url:'/settings',
      templateUrl:'/js/admin/templates/settings.html',
      controller:'HomeSettingsController'
    })
    .state('skills',{
      url:'/skills',
      templateUrl:'/js/admin/templates/skills.html',
      controller:'HomeSkillsController'
    })
    .state('singleuser',{
      url:'/singleuser',
      templateUrl:'/js/admin/templates/singleuser.html',
      controller:'HomeSingleuserController'
    })
    .state('qualification',{
      url:'/qualification-type',
      templateUrl:'/js/admin/templates/qualification-type.html',
      controller:'HomeQualificationController'
    })
}]);


/** FILTERS **/
appAccelaar.filter('company_type', function(){
  return function(input){
    if(!input) return null
    var newInput = input.replace('_',' ');
    return newInput.charAt(0).toUpperCase()+newInput.substr(1).toLowerCase()
  }
});

/** END FILTER **/
/**
 * Created by sibin on 9/10/2016.
 */
var appAccelaar = window.appAccelaar || angular.module('appAccelaar',['ngTagsInput']);

appAccelaar.controller('HomeController',['$scope','InternshipService',
    function($scope,InternshipService){
    $scope.title = "Internship List";
    $scope.internship_list = [];
    $scope.getInternshipData = function(tableState){
      tableState.pagination.number = tableState.pagination.number || 10;
      tableState.pagination.start  = tableState.pagination.start  || 0;
      InternshipService.internships().query(tableState, function(result){
        if(result.status == 200){
          //tableState.pagination.totalItemCount = result.totalItemCount;
          tableState.pagination.numberOfPages  = result.numberOfPages;
          $scope.internship_list = result.data;
        }
      });
    };
}]);






/* START HOME INTERNSHIP CONTROLLER */
/**
 * - List all internship fields and skills
 *
 */
appAccelaar.controller('HomeInternshipController',['$scope','InternshipService',
  function($scope,InternshipService){
  $scope.internship_list = []
  InternshipService.getInternshipList().then(function(result){
    if(result.data.status == 200){
      $scope.internship_list = result.data.data;
    }
  }, function(error){
    console.log(error)
  })
}]);
/* EOF HOME INTERNSHIP CONTROLLER */

/* START COMPANY CONTROLLER */
appAccelaar.controller('HomeCompanyController',['$scope','Company', function($scope,Company){
  $scope.companies = [];
  Company.company().then(function(result){
    console.log(result)
    console.log(result.data)
    $scope.companies = result.data
  }, function(error){
    console.log(error)
  }, function (update) {
    console.log(update)
  })
}]);

/* END COMPANY CONTROLLER */

/* START USER CONTROLLER */
appAccelaar.controller('HomeUserController',['$scope','User', function($scope,User){
  $scope.users = [];
  User.users().then(function(result){
    $scope.users = result.data;
  }, function(error){

  })
}]);
/* END USER CONTROLLER */

/* START SKILLS CONTROLLER */
appAccelaar.controller('HomeSkillsController',['$scope','General',
  function($scope, General){
  $scope.available_fields = [];
  $scope.skill_tags =  [];
  General.getSkills().then(function(result){
    if(result.status == 200){
      $scope.available_fields = result.data
    }
  }, function(error){
    console.log(error)
  });

  $scope.fetchSkills = function(id){
    $scope.$broadcast('skill_re_fetch',id)
  };

  $scope.$on('skill_re_fetch', function(event,id){
    console.log(id)
    General.getSkillsById(id).then(function(result){
      if(result.status == 200){
        if(result.data.status == 200){
          $scope.skill_tags = result.data.data;
        }else{
          $scope.skill_tags = [];

        }
      }
    }, function(error){
      console.log(error)
    })
  });

  $scope.saveTagsToField = function(){
    if($scope.skill_tag_add){
      General.saveSkillById($scope.get_field_id, $scope.skill_tag_add).then(function(result){
        if(result.status == 200 && result.data.status == 200){
          $scope.skill_tag_add = null;
          General.getSkillsById($scope.get_field_id).then(function(result){
            if(result.status == 200){
              if(result.data.status == 200){
                $scope.skill_tags = result.data.data;
              }
            }
          }, function(error){
            console.log(error)
          })
        }
      }, function(error){
        console.log(error)
      })
    }
  };
  $scope.loadTags = function(query){
    General.getSkills().then(function(result){
      return  result;
    }, function(error){
      console.log(error)
    })
  };

  $scope.removeSkill = function(event,skill){
    General.removeSkill(skill).then(function(result){
      if(result.status == 200 && result.data.status == 200){
        $scope.$broadcast('skill_re_fetch',skill.internship_field_id)
      }
      toastr.success("Skill removed")
    }, function(error){

    });

    event.stopPropagation();
  }

}]);

/* END START SKILLS CONTROLLER */

/* START SETTINGS CONTROLLER */
appAccelaar.controller('HomeSettingsController',['$scope', function($scope){

}]);

/* END START SETTINGS CONTROLLER */

/* START SINGLEUSER CONTROLLER */
appAccelaar.controller('HomeSingleuserController',['$scope', function($scope){

    $scope.tabs = [
      { title:'Dynamic Title 1', content:'Dynamic content 1' },
      { title:'Dynamic Title 2', content:'Dynamic content 2', disabled: true }
    ];

    $scope.alertMe = function() {
      setTimeout(function() {
        $window.alert('You\'ve selected the alert tab!');
      });
    };

    $scope.model = {
      name: 'Tabs'
    };
  $scope.navbarCollapsed = true;

}]);

/* END START SINGLEUSER CONTROLLER */

/* START QUALIFICATION TYPE CONTROLLER */
appAccelaar.controller('HomeQualificationController',[
  '$scope','General','$uibModal',
  function($scope,General,$uibModal){

    /* Load first */
    fetch_all_qualification = function(){
      $scope.qualification_types = [];

      General.qualificationType().query(function(result){
        if(result.length > 0) $scope.qualification_types = result
      }, function(error){
        console.log(error)
      })
    };
    /* end load first */



    fetch_all_qualification();
    /**
     *
     * @param event {event}
     * @param formData
     * @use Create/Add qualification data
     */
    $scope.saveFormData = function(event, formData){
      event.preventDefault();
      General.qualificationType().save(formData, function(result){
        if(result.status == 200){
          $scope.qualification = {}; // empty fields
          $scope.qualificationTypeForm.$setPristine();
          fetch_all_qualification()
        }
      }, function(error){
        console.log(error)
      })
    };

    /**
     *
     * @param event {event}
     * @param s_type {object}
     * @use Delete selected qualification type
     * @return Re fetch data
     */
    $scope.deleteType = function(event,s_type){
      if(!s_type.id) throw new Error("Id is not found");

      General.qualificationType().remove({id:s_type.id}, function(result){
        if(result.status == 200){
          fetch_all_qualification();
        }
      }, function(error){
        console.log(error)
      })
    };

    $scope.editModalType = function(event, data){
      event.preventDefault();
      var editQTypeModal = $uibModal.open({
        templateUrl:"edit_qualification_type_modal",
        controller:'homeEditQualificationTypeCtrl',
        size:'md',
        resolve:{
          item: function(){
            return data
          }
        }
      });

      editQTypeModal.result.then(function(status){
        console.log(status);
        if(status.status == 200){
          fetch_all_qualification();
        }
      });
    }
  }
]);

/* END QUALIFICATION TYPE CONTROLLER */

/* START QUALIFICATION EDIT MODAL CONTROLLER */
appAccelaar.controller('homeEditQualificationTypeCtrl',[
  '$scope','$uibModalInstance','item','General',
  function($scope,$uiModalInstance,item,General){
    $scope.item = item;

    $scope.closeModal = function(){
      $uiModalInstance.dismiss('cancel')
    };

    $scope.editQualificationSubmit = function(event, data){
      General.qualificationType().update({id: data.id},data, function(result){
        if(result.status == 200){
          $uiModalInstance.close(result)
        }
      }, function(error){
        console.log(error)
      })
    };
  }


]);

/* END QUALIFICATION EDIT MODAL CONTROLLER */
'use-strict';

appAccelaar.controller('InternshipController', ['$scope','InternshipService','$stateParams',
  function($scope,InternshipService,$stateParams){
  console.log($stateParams);
  $scope.internship = {};
  InternshipService.internships().get({id:$stateParams.id}, function(result){
    if(result.status== 200){
      $scope.internship = result.data;
    }
  }, function(error){
    console.log(error)
  })
}]);


var appAccelaar = window.appAccelaar || angular.module('appAccelaar',[]);
appAccelaar.service('Company',['$http','$q', function($http,$q){
  this.company = function(){
    var defer = $q.defer();
    $http.get('/api/admin/companies').then(function(result){
      defer.resolve(result)
    }, function(error){
      defer.reject(error)
    });
    return defer.promise;
  }
}]);
var appAccelaar = window.appAccelaar || angular.module('appAccelaar',[]);
appAccelaar.service('General',['$http','$q','$resource',
  function($http,$q,$resource){
  this.getSkills = function(query){
    var defer = $q.defer();
    $http.get('/api/get_fields').then(function(result){
      defer.resolve(result);
    }, function(error){
      console.log(error);
      defer.reject('not available');
    });
    return defer.promise;
  };
  this.getSkillsById = function(id){
    var defer = $q.defer();
    $http({
      url:'/api/get-skills-by-id/?id='+id,
      method: 'GET'
    }).then(function(result){
      defer.resolve(result)
    }, function(error){
      defer.reject(error)
    });
    return defer.promise;
  };
  this.saveSkillById = function(id,data){
    return $q(function(resolve,reject){
      var url = "/api/admin/save_skills_by_id";
      $http.post(url,{id:id,data:data}).then(function(result){
        resolve(result)
      }, function(error){
        reject(error)
      })
    });
  };
  this.removeSkill = function(skill){
    return $q(function(resolve,reject){
      var url = "/api/admin/delete_skill_by_id";
      $http.post(url,skill).then(function(result){
        resolve(result)
      }, function(error){
        reject(error)
      })
    })
  };

  this.qualificationType = function(){
    return $resource('/api/admin/qualification-type/:id',{
      id:'@id'
    },{
      update:{method:'PUT'}
    })
  };
}]);
var appAccelaar = window.appAccelaar || angular.module('appAccelaar',[]);
appAccelaar.factory('InternshipService',['$http','$q','$resource',
    function($http,$q,$resource){
    var getInternshipList = function(){
        return $q(function(resolve,reject){
            $http({
                url:'/api/get-internships-list',
                method:'GET'
            }).then(function(result){
                resolve(result)
            }, function(error){
                reject(error)
            })
        })
    };
    var internships = function(){
        return $resource('/api/admin/internships/:id',{id:'@id'},{
            query:{ method:'GET',isArray:false }
        })
    };
    return {
        getInternshipList: getInternshipList,
        internships:internships
    }
}]);
/**
 * Created by sibin on 9/18/2016.
 */
'use-strict';

appAccelaar.service('User',['$http','$q', function($http,$q){
  this.users = function(){
    var defer = $q.defer();
    $http.get('/api/admin/users').then(function(result){
      defer.resolve(result);
    }, function(error){
      defer.reject(error)
    });
    return defer.promise;
  }
}]);